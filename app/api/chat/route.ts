// import { generateText, generateObject } from "ai"
// import { openai } from "@ai-sdk/openai"
// import { z } from "zod"
// import { NextResponse } from "next/server"
// import { appKnowledgeBase } from "@/data/chatbot-app-knowledge"
// import { AssessmentService } from "@/lib/assessment-service"
// import { createClient } from "@supabase/supabase-js"
// import { searchPHQKnowledge, getAllPHQKeywords } from "@/data/phq-knowledge-base"
// import { searchAUDITKnowledge, getAllAUDITKeywords } from "@/data/audit-knowledge-base"

// // Define the message structure expected by the AI SDK
// interface AIMessage {
//   role: "user" | "assistant" | "system"
//   content: string
// }

// // Schema for intent classification
// const IntentSchema = z.object({
//   category: z.enum(["‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û", "‡πÅ‡∏≠‡∏õ VONIX", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"]),
// })

// // System prompt for health advice
// const HEALTH_SYSTEM_PROMPT = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ VONIX Assistant ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö

// **‡∏Å‡∏é‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î:**
// - **‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô**
// - **‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏ã‡πâ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô "‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö?") ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß**
// - **‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô "‡∏â‡∏±‡∏ô‡∏õ‡πà‡∏ß‡∏¢", "‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢", "‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á", "‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß") ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö? ‡∏õ‡∏ß‡∏î‡∏à‡∏∏‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏î ‡∏õ‡∏ß‡∏î‡∏ö‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏ß‡∏î‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö?" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö? ‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏°‡∏∏‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏™‡πâ‡∏Ñ‡∏£‡∏±‡∏ö?"**
// - **‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡∏°‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏Å‡∏≠‡∏∞" ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏Å‡∏≥‡∏Å‡∏ß‡∏° ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô**

// ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
// - ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå
// - ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ, ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á, ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
// - ‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡πâ‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á
// - ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à
// - ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô **) ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Markdown ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
// - ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏î‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå`

// // System prompt for intent classification
// const INTENT_CLASSIFICATION_PROMPT = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
// **‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏à‡∏ï‡∏ô‡∏≤ ‡∏´‡πâ‡∏≤‡∏°‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô**

// **‡∏Å‡∏é‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:**
// 1.  **‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û" ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å:** ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏°‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≥‡∏Å‡∏ß‡∏° ‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏õ‡πá‡∏ô "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û" ‡πÄ‡∏™‡∏°‡∏≠
// 2.  ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ VONIX (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ, ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å, ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö, ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô, ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå, ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å, ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç, ‡∏õ‡∏±‡∏ç‡∏´‡∏≤, ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢) ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡πÅ‡∏≠‡∏õ VONIX"
// 3.  ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"

// ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß‡∏ó‡∏≥‡πÑ‡∏á‡∏î‡∏µ" -> ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" -> ‡πÅ‡∏≠‡∏õ VONIX
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏á" -> ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô" -> ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏â‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô" -> ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏≠‡∏û‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏á" -> ‡πÅ‡∏≠‡∏õ VONIX
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡πÑ‡∏Ç‡πâ‡∏´‡∏ß‡∏±‡∏î" -> ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢" -> ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏â‡∏±‡∏ô‡∏õ‡πà‡∏ß‡∏¢" -> ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏â‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢" -> ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏â‡∏±‡∏ô‡∏´‡∏¥‡∏ß" -> ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß" -> ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏°‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏Å‡∏≠‡∏∞" -> ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏Å‡πÜ)
// - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ" -> ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
// `

// // System prompt for "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" intent
// const OTHER_SYSTEM_PROMPT = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ VONIX Assistant ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡πÅ‡∏ó‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏ã‡πâ‡∏≥`

// // System prompt for personalized health advice
// const PERSONALIZED_HEALTH_SYSTEM_PROMPT = (
//   userName: string,
//   healthData: string,
// ) => `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ VONIX Assistant ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö

// **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á ${userName} (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î):**
// ${healthData}

// **‡∏Å‡∏é‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î:**
// - **‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á ${userName} ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞**
// - **‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏ã‡πâ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô "‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö?") ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß**
// - **‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°**

// ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
// - ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á ${userName} ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
// - ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ, ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á, ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
// - ‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡πâ‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á
// - ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à
// - ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô **) ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Markdown ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
// - ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏î‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå
// `

// // Define critical health keywords for direct classification
// const CRITICAL_HEALTH_KEYWORDS = [
//   "‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô",
//   "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô",
//   "‡∏´‡∏±‡∏ß‡πÉ‡∏à",
//   "‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à",
//   "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô",
//   "‡∏Ñ‡∏≠‡πÄ‡∏•‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡∏≠‡∏•",
//   "‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î",
//   "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å",
//   "‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô",
//   "‡∏ú‡∏≠‡∏°‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ",
//   "‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏≤‡∏¢",
//   "BMI",
//   "‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏û‡πâ",
//   "‡∏´‡∏≠‡∏ö‡∏´‡∏∑‡∏î",
//   "‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß",
//   "‡πÑ‡∏°‡πÄ‡∏Å‡∏£‡∏ô",
//   "‡∏ß‡∏¥‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô",
//   "‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏°‡∏∏‡∏ô",
//   "‡πÉ‡∏à‡∏™‡∏±‡πà‡∏ô",
//   "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢",
//   "‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢",
//   "‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö",
//   "‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö‡∏¢‡∏≤‡∏Å",
//   "‡∏´‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏¥‡∏ó",
//   "‡∏´‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏•‡∏∂‡∏Å",
//   "‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤",
//   "‡∏ß‡∏¥‡∏ï‡∏Å‡∏Å‡∏±‡∏á‡∏ß‡∏•",
//   "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î",
//   "mental health",
//   "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï",
//   "DASS",
//   "PHQ",
//   "‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå",
//   "‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ",
//   "‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏™‡∏±‡πâ‡∏ô",
//   "‡∏™‡∏°‡∏≤‡∏ò‡∏¥",
//   "‡∏ß‡∏¥‡∏ï‡∏Å‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏°‡∏≤‡∏Å",
//   "‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß",
//   "‡πÇ‡∏£‡∏Ñ‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤",
//   "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î‡∏°‡∏≤‡∏Å",
//   "‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö‡πÄ‡∏•‡∏¢",
//   "‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠",
//   "‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏õ‡∏£‡∏õ‡∏£‡∏ß‡∏ô",
//   "‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î‡∏á‡πà‡∏≤‡∏¢",
//   "‡πÇ‡∏£‡∏Ñ‡∏ï‡∏±‡∏ö",
//   "‡πÑ‡∏ï",
//   "‡πÑ‡∏ó‡∏£‡∏≠‡∏¢‡∏î‡πå",
//   "‡∏ã‡∏µ‡∏™‡∏ï‡πå",
//   "‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á",
//   "‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á‡πÄ‡∏ï‡πâ‡∏≤‡∏ô‡∏°",
//   "‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á‡∏õ‡∏≤‡∏Å‡∏°‡∏î‡∏•‡∏π‡∏Å",
//   "‡∏ã‡∏µ‡∏™‡∏ï‡πå‡∏£‡∏±‡∏á‡πÑ‡∏Ç‡πà",
//   "‡∏°‡∏î‡∏•‡∏π‡∏Å",
//   "‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
//   "‡∏õ‡∏ß‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
//   "‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
//   "‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô",
//   "‡∏ß‡∏±‡∏¢‡∏ó‡∏≠‡∏á",
//   "‡∏†‡∏≤‡∏ß‡∏∞‡∏°‡∏µ‡∏ö‡∏∏‡∏ï‡∏£‡∏¢‡∏≤‡∏Å",
//   "‡∏´‡∏°‡∏≠",
//   "‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å",
//   "‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå",
//   "‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏´‡∏°‡∏≠",
//   "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û",
//   "‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û",
//   "‡πÄ‡∏à‡πá‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å",
//   "‡πÄ‡∏à‡πá‡∏ö‡∏ó‡πâ‡∏≠‡∏á",
//   "‡∏õ‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏á",
//   "‡∏õ‡∏ß‡∏î‡πÄ‡∏≠‡∏ß",
//   "‡∏õ‡∏ß‡∏î‡πÑ‡∏´‡∏•‡πà",
//   "‡∏õ‡∏ß‡∏î‡πÄ‡∏Ç‡πà‡∏≤",
//   "‡∏õ‡∏ß‡∏î‡∏Ç‡πâ‡∏≠",
//   "‡∏õ‡∏ß‡∏î‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠",
//   "‡∏ä‡∏≤‡πÅ‡∏Ç‡∏ô",
//   "‡∏ä‡∏≤‡∏Ç‡∏≤",
//   "‡∏¢‡∏≤‡∏ö‡∏≥‡∏£‡∏∏‡∏á",
//   "‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î",
//   "‡∏¢‡∏≤‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö",
//   "‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô",
//   "‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏ã‡∏µ",
//   "‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏î‡∏µ",
//   "‡πÇ‡∏≠‡πÄ‡∏°‡∏Å‡πâ‡∏≤",
//   "‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏™‡∏°‡∏≠‡∏á",
//   "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°",
//   "‡πÅ‡∏Ñ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢‡∏°",
//   "‡∏ò‡∏≤‡∏ï‡∏∏‡πÄ‡∏´‡∏•‡πá‡∏Å",
//   "‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô",
//   "‡∏´‡∏¥‡∏ß‡∏ö‡πà‡∏≠‡∏¢",
//   "‡∏õ‡∏±‡∏™‡∏™‡∏≤‡∏ß‡∏∞‡∏ö‡πà‡∏≠‡∏¢",
//   "‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠",
//   "‡∏ï‡∏∑‡πà‡∏ô‡∏ö‡πà‡∏≠‡∏¢‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô",
//   "‡∏ô‡∏≠‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô",
//   "‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏£‡∏á",
//   "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏£‡∏á",
//   "‡∏Ç‡∏µ‡πâ‡∏•‡∏∑‡∏°",
//   "‡∏°‡∏∑‡∏≠‡∏™‡∏±‡πà‡∏ô",
//   "‡πÄ‡∏ó‡πâ‡∏≤‡∏ä‡∏≤",
//   "‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÑ‡∏°‡πà‡∏≠‡∏¥‡πà‡∏°",
//   "‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏•‡∏≥‡∏ö‡∏≤‡∏Å",
//   "‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏∑‡∏î",
//   "‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏°",
//   "‡∏õ‡πà‡∏ß‡∏¢‡∏á‡πà‡∏≤‡∏¢",
//   "‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏á‡πà‡∏≤‡∏¢",
//   "‡πÅ‡∏ú‡∏•‡∏´‡∏≤‡∏¢‡∏ä‡πâ‡∏≤",
//   "‡πÅ‡∏ú‡∏•‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á",
//   "‡∏Ñ‡∏±‡∏î‡∏à‡∏°‡∏π‡∏Å",
//   "‡πÑ‡∏≠‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á",
//   "‡∏°‡∏µ‡πÑ‡∏Ç‡πâ",
//   "‡∏´‡∏ô‡∏≤‡∏ß‡∏™‡∏±‡πà‡∏ô",
//   "‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢",
//   "‡∏ó‡πâ‡∏≠‡∏á‡∏≠‡∏∑‡∏î",
//   "‡∏à‡∏∏‡∏Å‡πÅ‡∏ô‡πà‡∏ô",
//   "‡∏ó‡πâ‡∏≠‡∏á‡∏ú‡∏π‡∏Å",
//   "‡∏ñ‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å",
//   "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏¢‡πà‡∏≠‡∏¢",
//   "‡πÅ‡∏û‡πâ‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
//   "‡πÅ‡∏û‡πâ‡∏ô‡∏°‡∏ß‡∏±‡∏ß",
//   "‡∏ô‡∏°‡∏ñ‡∏±‡πà‡∏ß‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á",
//   "‡πÅ‡∏û‡πâ‡∏¢‡∏≤",
//   "‡πÇ‡∏£‡∏Ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠",
//   "‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤",
//   "‡πÅ‡∏ö‡∏Ñ‡∏ó‡∏µ‡πÄ‡∏£‡∏µ‡∏¢",
//   "‡πÑ‡∏ß‡∏£‡∏±‡∏™",
//   "HIV",
//   "HPV",
//   "‡πÄ‡∏≠‡∏î‡∏™‡πå",
//   "‡πÇ‡∏£‡∏Ñ‡πÄ‡∏û‡∏®‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå",
//   "‡πÇ‡∏£‡∏Ñ‡∏ï‡∏±‡∏ö‡πÅ‡∏Ç‡πá‡∏á",
//   "‡πÇ‡∏£‡∏Ñ‡πÄ‡∏Å‡πä‡∏≤‡∏ó‡πå",
//   "‡πÇ‡∏£‡∏Ñ‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡∏û‡∏£‡∏∏‡∏ô",
//   "‡πÄ‡∏ö‡∏ç‡∏à‡πÄ‡∏û‡∏™",
//   "‡∏´‡∏°‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥",
//   "‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô",
//   "‡∏ï‡∏£‡∏ß‡∏à‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢",
//   "‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏•‡∏∑‡∏≠‡∏î",
//   "‡∏ï‡∏£‡∏ß‡∏à‡∏†‡∏≤‡∏¢‡πÉ‡∏ô",
//   "‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏Ñ‡∏ß‡∏¥‡∏î",
//   "‡∏ï‡∏£‡∏ß‡∏à‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á",
//   "‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô",
//   "‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•",
//   "‡∏ï‡∏£‡∏ß‡∏à‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô",
//   "‡∏õ‡πà‡∏ß‡∏¢",
//   "‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢",
//   "‡∏´‡∏¥‡∏ß",
//   "‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á",
//   "‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß",
//   "‡πÅ‡∏õ‡∏•‡∏Å",
//   "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô",
//   "‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô",
//   "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á",
//   "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û",
//   "‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û",
//   "‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û",
//   "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏â‡∏±‡∏ô",
//   "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£",
//   "diabetes", "blood pressure", "heart", "cholesterol", "obesity", "overweight", "underweight",
//   "BMI", "allergy", "asthma", "headache", "migraine", "dizziness", "vertigo",
//   "palpitations", "fatigue", "tired", "insomnia", "sleep", "depression", "anxiety",
//   "stress", "mental health", "mood", "crying", "ADHD", "concentration", "suicidal",
//   "liver", "kidney", "thyroid", "cyst", "cancer", "menstruation", "period", "hormone",
//   "menopause", "infertility", "chest pain", "stomach pain", "back pain", "shoulder pain",
//   "knee pain", "joint pain", "muscle pain", "numb arm", "numb leg", "shortness of breath",
//   "fainting", "infection", "slow healing", "fever", "chills", "diarrhea", "bloating",
//   "constipation", "indigestion", "food allergy", "milk allergy", "soy milk", "drug allergy",
//   "STD", "hepatitis", "gout", "osteoporosis", "vaccine", "blood test", "cancer test",
//   "COVID test", "health check", "sick", "not feeling well", "hungry", "strange symptoms",
//   ...getAllPHQKeywords(),
//   ...getAllAUDITKeywords(),
// ]

// // Helper function to get risk level label
// const getRiskLevelLabel = (riskLevel: string): string => {
//   switch (riskLevel) {
//     case "low":
//       return "‡∏ï‡πà‡∏≥"
//     case "medium":
//       return "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"
//     case "high":
//       return "‡∏™‡∏π‡∏á"
//     case "very-high":
//       return "‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å"
//     default:
//       return "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
//   }
// }

// export async function POST(req: Request) {
//   try {
//     // Expect an array of messages, userName, and userId from the client
//     const { messages: clientMessages, userName } = (await req.json()) as {
//       messages: AIMessage[]
//       userName?: string
//       userId?: string // userId is now optional from client, will be derived from session
//     }

//     // Get user session from cookies on the server side
//     const supabaseServerClient = createClient(
//       process.env.NEXT_PUBLIC_SUPABASE_URL!,
//       process.env.SUPABASE_SERVICE_ROLE_KEY!,
//       {
//         auth: {
//           persistSession: false, // Do not persist session on server
//         },
//       },
//     )
//     const {
//       data: { user },
//     } = await supabaseServerClient.auth.getUser()
//     const userId = user?.id || null

//     // The last message is the current user's query
//     const userMessageContent = clientMessages[clientMessages.length - 1].content.toLowerCase()

//     // Prepare messages for AI SDK
//     const conversationHistoryForAI = clientMessages.map((msg) => ({
//       role: msg.role,
//       content: msg.content,
//     }))

//     let botResponse = "" 
//     let intentCategory: z.infer<typeof IntentSchema>["category"]
//     let healthDataSummary = ""
//     let hasPersonalizedHealthData = false

//     // --- Fetch personalized health data if user is logged in ---
//     if (userId) {
//       try {
//         // Pass the supabase client to the service method
//         const { data: latestAssessments, error: fetchError } = await AssessmentService.getLatestUserAssessments(
//           supabaseServerClient, // Use the server-side client
//           userId,
//         )

//         if (fetchError) {
//           // Continue without personalized data if there's an error
//         } else if (latestAssessments && latestAssessments.length > 0) {
//           hasPersonalizedHealthData = true

//           healthDataSummary = latestAssessments
//             .map((assessment) => {
//               const riskLabel = getRiskLevelLabel(assessment.risk_level)
//               const factors =
//                 assessment.risk_factors && assessment.risk_factors.length > 0
//                   ? `‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: ${assessment.risk_factors.join(", ")}`
//                   : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏"
//               const recommendations =
//                 assessment.recommendations && assessment.recommendations.length > 0
//                   ? `‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${assessment.recommendations.join(", ")}`
//                   : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞"

//               return `
// - ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ${assessment.category_title} (ID: ${assessment.category_id})
//   - ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: ${riskLabel} (${assessment.percentage}%)
//   - ${factors}
//   - ${recommendations}
//   - ‡∏ó‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(assessment.completed_at).toLocaleDateString("th-TH")}
//           `.trim()
//             })
//             .join("\n\n")

//           healthDataSummary = `‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:\n\n${healthDataSummary}\n\n‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ`
//         } else {
//           healthDataSummary = "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"
//         }
//       } catch (error) {
//         healthDataSummary = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û"
//       }
//     } else {
//       healthDataSummary = "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÑ‡∏î‡πâ"
//     }

//     // --- Direct classification for critical health keywords (Priority 1) ---
//     let isCriticalHealthQuery = false
//     for (const keyword of CRITICAL_HEALTH_KEYWORDS) {
//       if (userMessageContent.includes(keyword)) {
//         isCriticalHealthQuery = true
//         break
//       }
//     }

//     if (isCriticalHealthQuery) {
//       intentCategory = "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û" // Force health intent
//     } else {
//       // --- AI-based intent classification (Priority 2) ---
//       const { object: intentClassification } = await generateObject({
//         model: openai("gpt-4o"),
//         system: INTENT_CLASSIFICATION_PROMPT,
//         messages: conversationHistoryForAI, // Pass full history for context
//         schema: IntentSchema,
//       })
//       intentCategory = intentClassification.category
//     }

import { generateText, generateObject } from "ai"
import { openai } from "@ai-sdk/openai"
import { z } from "zod"
import { NextResponse } from "next/server"
import { appKnowledgeBase } from "@/data/chatbot-app-knowledge"
import { AssessmentService } from "@/lib/assessment-service"
import { createClient } from "@supabase/supabase-js"
import { searchPHQKnowledge, getAllPHQKeywords } from "@/data/phq-knowledge-base"
import { searchAUDITKnowledge, getAllAUDITKeywords } from "@/data/audit-knowledge-base"

// Define the message structure expected by the AI SDK
interface AIMessage {
  role: "user" | "assistant" | "system"
  content: string
}

// Schema for intent classification
const IntentSchema = z.object({
  category: z.enum(["‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û", "‡πÅ‡∏≠‡∏õ VONIX", "‡∏≠‡∏∑‡πà‡∏ô‡πÜ", "Health", "VONIX App", "Other"]),
})

// System prompt for intent classification (bilingual: Thai + English)
const INTENT_CLASSIFICATION_PROMPT = `You are an assistant that classifies the user's intent into categories.

**Rules (Thai + English):**
1. If the latest message relates to health (‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û), even slightly or ambiguously, classify as "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û" or "Health".
2. If the latest message is about using the VONIX app (‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ, ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å, login, subscription, assessment, results, records, edit, problems, data, security), classify as "‡πÅ‡∏≠‡∏õ VONIX" or "VONIX App".
3. If the message is unrelated to both health and the app, classify as "‡∏≠‡∏∑‡πà‡∏ô‡πÜ" or "Other".

**Important:**
- Only consider the most recent user message for classification, never past conversation.
- Health has the highest priority. If unsure, classify as Health/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û.

Examples:
- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß‡∏ó‡∏≥‡πÑ‡∏á‡∏î‡∏µ" -> ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
- User: "I have a headache" -> Health
- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" -> ‡πÅ‡∏≠‡∏õ VONIX
- User: "How to register an account" -> VONIX App
- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏á" -> ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
- User: "What is the weather today?" -> Other
- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏â‡∏±‡∏ô‡∏Å‡∏•‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô" -> ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
- User: "I think I might have diabetes" -> Health
- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏≠‡∏û‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏á" -> ‡πÅ‡∏≠‡∏õ VONIX
- User: "How do I use this app?" -> VONIX App
- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏°‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏Å‡∏≠‡∏∞" -> ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
- User: "Something feels strange" -> Health
- ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ" -> ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
- User: "Hello" -> Other`

// System prompt for health advice Bilingual
const HEALTH_SYSTEM_PROMPT = `You are VONIX Assistant, a personal health assistant.
Reply in the same language as the user's last message.
If the user writes in Thai, reply in Thai.
If the user writes in English, reply in English.

‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ VONIX Assistant ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö

‡∏Å‡∏é‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î:
- ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏ã‡πâ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô "‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö?") ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
- ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô "‡∏â‡∏±‡∏ô‡∏õ‡πà‡∏ß‡∏¢", "‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢", "‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á", "‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß") ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö? ‡∏õ‡∏ß‡∏î‡∏à‡∏∏‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏î ‡∏õ‡∏ß‡∏î‡∏ö‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏ß‡∏î‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö?" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö? ‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏°‡∏∏‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏™‡πâ‡∏Ñ‡∏£‡∏±‡∏ö?"
- ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ "‡∏°‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏Å‡∏≠‡∏∞" ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡∏Å‡∏≥‡∏Å‡∏ß‡∏° ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
- ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå
- ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ, ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á, ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
- ‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡πâ‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á
- ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô **) ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Markdown ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
- ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏î‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå
---
Rules in English:
- When answering, consider only the user's most recent message in the conversation.
- Do not repeat greetings or generic questions if the user has already asked something specific.
- If the user reports feeling sick or unwell (e.g., "I am sick", "stomach ache", "dizzy"), ask for more specific symptoms to give better advice. For example: "What kind of stomach pain do you have? Is it cramping, stabbing, or something else?" or "What kind of dizziness are you experiencing? Vertigo or nausea?"
- If the user says something vague like "It feels strange", ask for clarification about what feels strange.
Your role:
- Provide simple and useful health advice.
- Answer questions about common symptoms, self-care, disease prevention, and general health promotion.
- Always emphasize that your advice is not a medical diagnosis and that the user should consult a doctor or professional if symptoms are severe or persistent.
- Use polite, friendly, and encouraging English.
- Do not use bold formatting (**) or other Markdown formatting in your responses.
- If the question is too complex or requires a medical diagnosis, recommend that the user consult a doctor.`

// System prompt for "‡∏≠‡∏∑‡πà‡∏ô‡πÜ", "other" intent
const OTHER_SYSTEM_PROMPT = `You are VONIX Assistant, an assistant specialized only in health and the VONIX app.
Reply in the same language as the user's last message.
If the user writes in Thai, reply in Thai.
If the user writes in English, reply in English.

‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ VONIX Assistant ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≠‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡πÅ‡∏ó‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏ã‡πâ‡∏≥
---
English version:
You are VONIX Assistant, an assistant focused only on health and the VONIX application.
If the user asks something unrelated to health or the app, politely reply that you specialize only in these two areas, and encourage the user to ask a health-related or app-related question instead.
Do not answer unrelated questions.
Do not repeat greetings.`

// System prompt for personalized health advice (bilingual)
const PERSONALIZED_HEALTH_SYSTEM_PROMPT = (
  userName: string,
  healthData: string,
) => `You are VONIX Assistant, a personal health assistant.
Reply in the same language as the user's last message.
If the user writes in Thai, reply in Thai.
If the user writes in English, reply in English.

‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ VONIX Assistant ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÇ‡∏†‡∏ä‡∏ô‡∏≤‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö

‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á ${userName} (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î):
${healthData}
‡∏Å‡∏é‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î:
- ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á ${userName} ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞
- ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏ã‡πâ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ã‡πâ‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô "‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö?") ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
- ‡∏´‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢ ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
- ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á ${userName} ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤
- ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ, ‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á, ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
- ‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡πâ‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ß‡πà‡∏≤‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏∑‡πâ‡∏≠‡∏£‡∏±‡∏á
- ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô **) ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Markdown ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
- ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡πÇ‡∏î‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå
---

English version:
You are VONIX Assistant, a personal health assistant specializing in general health, nutrition, fitness, mental health, and sleep.

Latest health data for ${userName} (based on the most recent assessment):
${healthData}
Important rules:
- When answering, only consider the user's most recent message and the health data provided above about ${userName}.
- Do not repeat greetings or generic questions (e.g., "How can I help you?") if the user has already asked something specific.
- If the user reports feeling sick or unwell, ask for more specific details about their symptoms.
Your role:
- Provide simple, useful, personalized health advice based on the health data of ${userName}.
- Answer questions about common symptoms, self-care, disease prevention, and health promotion.
- Always emphasize that your advice is not a medical diagnosis, and recommend consulting a doctor or professional if symptoms are severe or persistent.
- Use polite, friendly, encouraging English.
- Do not use bold formatting (**) or other Markdown formatting in your responses.
- If the question is too complex or requires a medical diagnosis, advise the user to consult a doctor.`

// Define critical health keywords for direct classification
const CRITICAL_HEALTH_KEYWORDS = [
  // Thai critical health keywords
  "‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô", "‡∏´‡∏±‡∏ß‡πÉ‡∏à", "‡πÇ‡∏£‡∏Ñ‡∏´‡∏±‡∏ß‡πÉ‡∏à", "‡πÑ‡∏Ç‡∏°‡∏±‡∏ô", "‡∏Ñ‡∏≠‡πÄ‡∏•‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡∏≠‡∏•", "‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•‡πÉ‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î",
  "‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å", "‡πÇ‡∏£‡∏Ñ‡∏≠‡πâ‡∏ß‡∏ô", "‡∏ú‡∏≠‡∏°‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ", "‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏°‡∏ß‡∏•‡∏Å‡∏≤‡∏¢", "BMI", "‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏û‡πâ", "‡∏´‡∏≠‡∏ö‡∏´‡∏∑‡∏î", "‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß",
  "‡πÑ‡∏°‡πÄ‡∏Å‡∏£‡∏ô", "‡∏ß‡∏¥‡∏á‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô", "‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏°‡∏∏‡∏ô", "‡πÉ‡∏à‡∏™‡∏±‡πà‡∏ô", "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢", "‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢", "‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö",
  "‡∏´‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏ô‡∏¥‡∏ó", "‡∏ã‡∏∂‡∏°‡πÄ‡∏®‡∏£‡πâ‡∏≤", "‡∏ß‡∏¥‡∏ï‡∏Å‡∏Å‡∏±‡∏á‡∏ß‡∏•", "‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î", "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏à‡∏¥‡∏ï", "‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå", "‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ",
  "‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠", "‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠", "‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÅ‡∏õ‡∏£‡∏õ‡∏£‡∏ß‡∏ô", "‡∏´‡∏á‡∏∏‡∏î‡∏´‡∏á‡∏¥‡∏î‡∏á‡πà‡∏≤‡∏¢", "‡∏°‡∏∞‡πÄ‡∏£‡πá‡∏á", "‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á",
  "‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß", "‡∏õ‡πà‡∏ß‡∏¢", "‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢", "‡∏°‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏Å", "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô", "‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô",
  // English critical health keywords
  "diabetes", "blood pressure", "heart", "heart disease", "cholesterol", "blood sugar",
  "weight", "obesity", "overweight", "underweight", "BMI", "allergy", "asthma",
  "headache", "migraine", "dizziness", "vertigo", "palpitations", "fatigue", "tired",
  "insomnia", "sleep", "depression", "anxiety", "stress", "mental health", "mood",
  "crying", "ADHD", "concentration", "suicidal", "cancer", "period", "hormone",
  "menopause", "infertility", "chest pain", "stomach pain", "back pain", "shoulder pain",
  "joint pain", "muscle pain", "numb arm", "numb leg", "shortness of breath", "fainting",
  "infection", "fever", "diarrhea", "constipation", "indigestion", "food allergy",
  "drug allergy", "STD", "hepatitis", "osteoporosis", "vaccine", "blood test",
  "health check", "sick", "not feeling well", "hungry", "strange symptoms",
  ...getAllPHQKeywords(),
  ...getAllAUDITKeywords(),
]

// Helper function to get risk level label
const getRiskLevelLabel = (riskLevel: string): string => {
  switch (riskLevel) {
    case "low":
      return "‡∏ï‡πà‡∏≥"
    case "medium":
      return "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"
    case "high":
      return "‡∏™‡∏π‡∏á"
    case "very-high":
      return "‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å"
    default:
      return "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
  }
}

export async function POST(req: Request) {
  try {
    // Expect an array of messages, userName, and userId from the client
    const { messages: clientMessages, userName } = (await req.json()) as {
      messages: AIMessage[]
      userName?: string
      userId?: string // userId is now optional from client, will be derived from session
    }

    // Get user session from cookies on the server side
    const supabaseServerClient = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL!,
      process.env.SUPABASE_SERVICE_ROLE_KEY!,
      {
        auth: {
          persistSession: false, // Do not persist session on server
        },
      },
    )
    const {
      data: { user },
    } = await supabaseServerClient.auth.getUser()
    const userId = user?.id || null

    // The last message is the current user's query
    const userMessageContent = clientMessages[clientMessages.length - 1].content.toLowerCase()

    // Prepare messages for AI SDK
    const conversationHistoryForAI = clientMessages.map((msg) => ({
      role: msg.role,
      content: msg.content,
    }))

    let botResponse = "" 
    let intentCategory: z.infer<typeof IntentSchema>["category"]
    let healthDataSummary = ""
    let hasPersonalizedHealthData = false

    // --- Fetch personalized health data if user is logged in ---
    if (userId) {
      try {
        // Pass the supabase client to the service method
        const { data: latestAssessments, error: fetchError } = await AssessmentService.getLatestUserAssessments(
          supabaseServerClient, // Use the server-side client
          userId,
        )

        if (fetchError) {
          // Continue without personalized data if there's an error
        } else if (latestAssessments && latestAssessments.length > 0) {
          hasPersonalizedHealthData = true

          healthDataSummary = latestAssessments
            .map((assessment) => {
              const riskLabel = getRiskLevelLabel(assessment.risk_level)
              const factors =
                assessment.risk_factors && assessment.risk_factors.length > 0
                  ? `‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: ${assessment.risk_factors.join(", ")}`
                  : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏"
              const recommendations =
                assessment.recommendations && assessment.recommendations.length > 0
                  ? `‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ${assessment.recommendations.join(", ")}`
                  : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞"

              return `
- ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ${assessment.category_title} (ID: ${assessment.category_id})
  - ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: ${riskLabel} (${assessment.percentage}%)
  - ${factors}
  - ${recommendations}
  - ‡∏ó‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date(assessment.completed_at).toLocaleDateString("th-TH")}
          `.trim()
            })
            .join("\n\n")

          healthDataSummary = `‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:\n\n${healthDataSummary}\n\n‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ`
        } else {
          healthDataSummary = "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"
        }
      } catch (error) {
        healthDataSummary = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û"
      }
    } else {
      healthDataSummary = "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÑ‡∏î‡πâ"
    }

    // --- Direct classification for critical health keywords (Priority 1) ---
    let isCriticalHealthQuery = false
    for (const keyword of CRITICAL_HEALTH_KEYWORDS) {
      if (userMessageContent.includes(keyword)) {
        isCriticalHealthQuery = true
        break
      }
    }

    if (isCriticalHealthQuery) {
      intentCategory = "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û" // Force health intent
    } else {
      // --- AI-based intent classification (Priority 2) ---
      const { object: intentClassification } = await generateObject({
        model: openai("gpt-4o"),
        system: INTENT_CLASSIFICATION_PROMPT,
        messages: conversationHistoryForAI, // Pass full history for context
        schema: IntentSchema,
      })
      intentCategory = intentClassification.category
    }
    // HERE 
    if (intentCategory === "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û") {
      // If it's a health-related question, generate a health advice
      let systemPromptToUse = HEALTH_SYSTEM_PROMPT

      // Always use personalized health prompt if data is available
      if (hasPersonalizedHealthData) {
        systemPromptToUse = PERSONALIZED_HEALTH_SYSTEM_PROMPT(userName || "‡∏Ñ‡∏∏‡∏ì", healthDataSummary)
      } else {
        // If no data, inform them
        botResponse = `‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ${userName || "‡∏Ñ‡∏∏‡∏ì"} ‡∏ú‡∏°‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üòä`
      }

      if (!botResponse) {
        // Only generate if botResponse hasn't been set by the "no data" case
        const { text: healthResponse } = await generateText({
          model: openai("gpt-4o"),
          system: systemPromptToUse,
          messages: conversationHistoryForAI, // Pass full history for context
        })
        botResponse = healthResponse
      }
    } else if (intentCategory === "‡πÅ‡∏≠‡∏õ VONIX") {
      // Check PHQ-specific questions first
      const phqKnowledge = searchPHQKnowledge(userMessageContent)
      if (phqKnowledge) {
        botResponse = phqKnowledge.response.replace("{userName}", userName || "‡∏Ñ‡∏∏‡∏ì")
      } else {
        // Check AUDIT-specific questions
        const auditKnowledge = searchAUDITKnowledge(userMessageContent)
        if (auditKnowledge) {
          botResponse = auditKnowledge.response.replace("{userName}", userName || "‡∏Ñ‡∏∏‡∏ì")
        } else {
          // Implement simple RAG for general app-related questions
          let foundAppResponse = false
          for (const entry of appKnowledgeBase) {
            if (entry.keywords.some((keyword) => userMessageContent.includes(keyword))) {
              botResponse = entry.response.replace("{userName}", userName || "‡∏Ñ‡∏∏‡∏ì")
              foundAppResponse = true
              break
            }
          }

          if (!foundAppResponse) {
            // Fallback to AI if no specific hardcoded app response is found
            const { text: appRelatedResponse } = await generateText({
              model: openai("gpt-4o"),
              system: `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ VONIX ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏≠‡∏õ`,
              messages: conversationHistoryForAI,
            })
            botResponse = appRelatedResponse
          }
        }
      }
    } else {
      // If it's neither health nor app-related, use AI to provide a refusal/redirection message
      const { text: otherResponse } = await generateText({
        model: openai("gpt-4o"),
        system: OTHER_SYSTEM_PROMPT,
        messages: conversationHistoryForAI,
      })
      botResponse = otherResponse
    }

    return NextResponse.json({ response: botResponse })
  } catch (error) {
    return NextResponse.json(
      { error: "‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üòÖ" },
      { status: 500 },
    )
  }
}
